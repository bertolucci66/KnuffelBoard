<div *ngIf="game() as g" class="overflow-x-auto card paper-card compact">
  <div class="card-body p-0">
    <div class="flex items-center justify-between p-3 border-b border-base-300 bg-base-200/60">
      <div class="h3 m-0">Spielzettel
        <div class="text-xs opacity-70 font-normal">Erstellt von Norbert Gutbrod</div>
      </div>
      <div class="flex items-center gap-2">
        <span class="badge badge-ghost" *ngIf="g.status==='active'">Laufzeit: {{ elapsed() }}</span>
        <button class="btn btn-error btn-sm" (click)="requestAbort()" title="Neues Spiel starten â€“ aktuelles verwerfen">Neues Spiel</button>
        <span class="opacity-70 hidden md:inline">{{ unlocked ? 'Entsperrt â€“ Ã„nderungen erlaubt' : 'Gesperrt â€“ zum Bearbeiten entsperren' }}</span>
        <button class="btn btn-sm" [class.btn-warning]="unlocked" [class.btn-ghost]="!unlocked" (click)="toggleUnlock()">
          <span class="mr-1">{{ unlocked ? 'Sperren' : 'Entsperren' }}</span>
          <span>{{ unlocked ? 'ðŸ”’' : 'ðŸ”“' }}</span>
        </button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="table">
        <thead class="sticky top-0 z-10 bg-base-200">
          <tr>
            <th class="text-lg">Kategorie</th>
            <th class="text-lg" *ngFor="let p of g.players">{{p.name}}</th>
          </tr>
        </thead>
        <tbody>
          <ng-container>
            <!-- Dark separator above upper section -->
            <tr><td [attr.colspan]="1 + g.players.length" class="p-0"><div class="border-t-4 border-base-300/90"></div></td></tr>
            <tr class="bg-base-200/70">
              <td class="font-bold" [attr.colspan]="1 + g.players.length">Oberer Teil</td>
            </tr>
            <tr *ngFor="let c of upper; let i = index" class="border-b border-base-300" [ngClass]="{ 'bg-base-100': i % 2 === 0, 'bg-base-200': i % 2 === 1 }">
              <td class="font-semibold">{{ label(c) }}</td>
              <td *ngFor="let p of g.players" class="align-middle">
                <div class="flex items-center gap-2">
                  <input class="input input-md input-bordered w-28 blue-outlined" [class.scored]="isLocked(p.id,c)" type="number" min="0" inputmode="numeric" pattern="[0-9]*"
                         [disabled]="isLocked(p.id,c)" [(ngModel)]="cellValues[p.id][c]" (blur)="commit(p.id,c)" (keyup.enter)="commit(p.id,c)" />
                  <button class="btn btn-xs btn-ghost" [disabled]="isLocked(p.id,c)" (click)="strike(p.id,c)" title="Streichen (0)">âœ–ï¸Ž</button>
                  <span *ngIf="upperTendency(p.id, c) as t" class="badge badge-sm px-2 py-0.5 ml-1" [class.badge-success]="t.kind==='over'" [class.badge-warning]="t.kind==='under'" [class.badge-ghost]="t.kind==='on'">{{ t.label }}</span>
                </div>
              </td>
            </tr>
            <tr class="bg-base-300 border-y-2 border-base-400">
              <td class="font-semibold">Oberer Teil Summe</td>
              <td class="text-xl font-extrabold" *ngFor="let p of g.players">
                {{ g.computed[p.id]?.upper ?? 0 }}
                <span *ngIf="upperSumTendency(p.id) as t" class="badge badge-sm px-2 py-0.5 ml-2" [class.badge-success]="t.kind==='over'" [class.badge-warning]="t.kind==='under'" [class.badge-ghost]="t.kind==='on'">{{ t.label }}</span>
              </td>
            </tr>
            <tr class="bg-base-300 border-b-2 border-base-300">
              <td class="font-semibold">Bonus</td>
              <td class="text-xl font-bold" *ngFor="let p of g.players">{{ g.computed[p.id]?.bonus ?? 0 }}</td>
            </tr>
            <!-- Dark separator above lower section -->
            <tr><td [attr.colspan]="1 + g.players.length" class="p-0"><div class="border-t-4 border-base-300/90"></div></td></tr>
            <tr class="bg-base-200/70">
              <td class="font-bold" [attr.colspan]="1 + g.players.length">Unterer Teil</td>
            </tr>
            <tr *ngFor="let c of lower; let i = index" class="border-b border-base-300" [ngClass]="{ 'bg-base-100': i % 2 === 0, 'bg-base-200': i % 2 === 1 }">
              <td class="font-semibold">{{ label(c) }}</td>
              <td *ngFor="let p of g.players" class="align-middle">
                <div class="flex items-center gap-2">
                  <input class="input input-md input-bordered w-28 blue-outlined" [class.scored]="isLocked(p.id,c)" type="number" min="0" inputmode="numeric" pattern="[0-9]*"
                         [disabled]="isLocked(p.id,c)" [(ngModel)]="cellValues[p.id][c]" (blur)="commit(p.id,c)" (keyup.enter)="commit(p.id,c)" />
                  <button class="btn btn-xs btn-ghost" [disabled]="isLocked(p.id,c)" (click)="strike(p.id,c)" title="Streichen (0)">âœ–ï¸Ž</button>
                  <button *ngIf="isFixedCategory(c)" class="btn btn-xs btn-outline" [disabled]="isLocked(p.id,c)"
                          (click)="quickSet(p.id,c)" [title]="quickSetTitle(c)" aria-label="{{ quickSetTitle(c) }}">{{ fixedValue(c) }}</button>
                </div>
              </td>
            </tr>
            <tr class="border-b border-base-300">
              <td class="font-semibold">Kniffelâ€‘Bonus</td>
              <td *ngFor="let p of g.players" class="align-middle">
                <div class="flex items-center gap-2">
                  <button class="btn btn-xs" [class.btn-ghost]="!canAdjustBonus(p.id)" [class.btn-outline]="canAdjustBonus(p.id)"
                          [disabled]="!canAdjustBonus(p.id) || bonusValue(p.id) <= 0" (click)="adjustBonus(p.id,-50)">âˆ’ 50</button>
                  <input class="input input-md input-bordered w-28 blue-outlined" [value]="bonusValue(p.id)" readonly disabled />
                  <button class="btn btn-xs" [class.btn-ghost]="!canAdjustBonus(p.id)" [class.btn-outline]="canAdjustBonus(p.id)"
                          [disabled]="!canAdjustBonus(p.id)" (click)="adjustBonus(p.id,50)">+ 50</button>
                </div>
                <div class="text-xs opacity-60" *ngIf="!canAdjustBonus(p.id)">BenÃ¶tigt gÃ¼ltigen Kniffel (50)</div>
              </td>
            </tr>
            <tr class="bg-base-300 border-y-2 border-base-400">
              <td class="font-semibold">Unterer Teil Summe</td>
              <td class="text-xl font-extrabold tracking-wide" *ngFor="let p of g.players">{{ g.computed[p.id]?.lower ?? 0 }}</td>
            </tr>
            <tr class="bg-base-300 font-extrabold border-t-2 border-base-300">
              <td>Gesamt</td>
              <td class="text-2xl" *ngFor="let p of g.players">{{ g.computed[p.id]?.total ?? 0 }}</td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
    <div class="p-4 flex flex-col md:flex-row md:justify-between gap-3 items-start md:items-center">
      <div class="text-sm opacity-70">
        <div>- Eingetragene Felder werden gesperrt. Zum Ã„ndern bitte oben entsperren.</div>
        <div>- â€žStreichenâ€œ setzt den Wert auf 0 und sperrt das Feld.</div>
      </div>
      <div class="flex items-center gap-3 self-end md:self-auto">
        <ng-container *ngIf="g.status === 'finished'; else activeActions">
          <button class="btn btn-primary btn-lg" (click)="startNewGame()">Neues Spiel</button>
        </ng-container>
        <ng-template #activeActions>
          <span class="opacity-70" *ngIf="!g.allFilled">Bitte alle Felder ausfÃ¼llen.</span>
          <button class="btn btn-primary btn-lg" [disabled]="!g.allFilled" (click)="finish()">Spiel beenden & werten</button>
        </ng-template>
      </div>
    </div>
  </div>
</div>
<app-ranking-modal [open]="isRanking()" [ranking]="ranking()" [onClose]="closeRanking"></app-ranking-modal>
